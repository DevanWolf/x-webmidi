<!--
Copyright (c) 2015 Ryoya Kawai. All rights reserved.
Distributed under the MIT License (license terms are at http://opensource.org/licenses/MIT).
-->
<dom-module id="wm-smfplayer">
  <style></style>
  <template></template>
  <script type="text/javascript" src="./js/smfParser.js"></script>
  <script type="text/javascript" src="./js/smfPlayer.js"></script>
</dom-module>
<script type="text/javascript">
Polymer({
    is:"wm-smfplayer",
    properties: {
        midifile: {
            type: String,
            value: null
        }
    },
    ready: function() {
        var path=location.pathname.split("/");
        path.pop();
        var file_url=location.protocol+"//"+location.hostname+path.join("/")+"/"+this.midifile;
        var xhr=new XMLHttpRequest();

        this.smfParser = new SmfParser();

        xhr.responseType = "arraybuffer";
        xhr.open('GET', file_url, true);
        xhr.onreadystatechange=function(){
            if (xhr.readyState === 4 && xhr.status === 200){
                var arrayBuffer=xhr.response;
                var midi_binary="";
                if (arrayBuffer) {
                    var byteArray = new Uint8Array(arrayBuffer);
                    for(var i=0; i<byteArray.byteLength; i++) {
                        midi_binary+=String.fromCharCode(byteArray[i]);
                    }
                    this.parsedMidi=this.smfParser.parse(midi_binary)
                }
            }
        }.bind(this);
        xhr.onprogress=function(event){
            var progress=parseInt(100*(event.loaded/event.totalSize), 10);
            console.info("[progress] ", progress);
        };
        xhr.send(null);
    },
    attached: function() {
        // used be a domReady
        this.async(function() {
        }.bind(this));
    }, 
    startPlay: function(output) {
        console.log(output);
        this.smfPlayer = new SmfPlayer(output);
        this.smfPlayer.init(this.parsedMidi, 1200, 0);
        this.smfPlayer.startPlay();
    },
    stopPlay: function() {
        this.smfPlayer.stopPlay();
    },
    allSoundOff: function() {
        this.smfPlayer.allSoundOff();
    }
    
});
</script>